!function(){angular.module("angular.aws.s3",[]).directive("s3",function(e){function t(t,o,i,n){function s(){angular.forEach(t.files,function(o,i){o.lastModified&&!o.error&&e.process(o,i,t,n).then(function(e){angular.isFunction(t.options.on_success)&&t.options.on_success("File uploaded success",e)},function(){a("upload",o)})})}function a(e,o){n.$setValidity(e,!1),angular.isFunction(t.options["on_error_"+e])&&t.options["on_"+e](o),angular.isFunction(t.options.on_error)&&t.options.on_error(e,o),t.$emit("s3uploader:error:"+e,o),t.$emit("s3uploader:error",o),angular.isObject(o)&&(o.error=!0),l++}var r=angular.element('<input type="file">'),l=0;t.options.multiple&&r.attr("multiple","true"),r.css({opacity:0,position:"absolute",top:0,right:0,width:"100%",height:"100%"}).bind("change",function(e){var o=e.target.files;angular.forEach(o,function(e){t.files.push(e)}),t.$apply(),t.options.immediate&&t.upload()}),o.css({position:"relative",overflow:"hidden"}).append(r),n.$render=function(){t.files=n.$viewValue},t.$watch("files",function(e){var o=0,s=0;l=0,n.$setValidity("upload",!0),angular.forEach(e,function(e){if(e.error=!1,n.$setValidity("extension",!0),angular.isArray(t.options.extensions)&&t.options.extensions.length>0){var i=e.name.split(".").pop().toLowerCase();-1==t.options.extensions.indexOf(i)&&a("extension",e)}n.$setValidity("filesize",!0),t.options.filesize>0&&t.options.filesize<e.size&&a("filesize",e),e.success===!0&&o++,s+=e.size}),t.options.limit>0&&e.length>t.options.limit?a("totalfiles",e):n.$setValidity("totalfiles",!0),t.options.totalsize>0&&t.options.totalsize<s?a("totalsize",e):n.$setValidity("totalsize",!0),i.required&&0==o&&0==l?a("required",e):n.$setValidity("required",!0)},!0),t.$on("s3uploader:start",function(){t.upload()}),t.upload=function(){t.start_upload_state=!0,n.$setValidity("policy_content",!0),n.$setValidity("policy_get",!0),n.$setValidity("policy_set",!0),angular.isObject(t.options.policy)?s():t.options.policyUrl?$http.get(t.options.policyUrl).success(function(e){return angular.isObject(e)?(t.options.policy=e,void s()):void a("policy_content",e)}).error(function(e){a("policy_get",e)}):a("policy_set",null)}}return{restrict:"EA",link:t,require:"ngModel",scope:{options:"="}}}).factory("S3UploaderSrv",function(e,t){function o(o,i,n,s){function a(e){if(e.lengthComputable){var t=e.loaded-h;h=e.loaded;var i=(new Date).getTime(),a=(i-v)/1e3;v=i,m++,b+=t/a*8,o.speed=b/m,o.progress=Math.round(100*e.loaded/e.total)}s.$setViewValue(n.files)}function r(e){var t=e.srcElement||e.target;204===t.status?(o.real="https://"+n.options.bucket+".s3.amazonaws.com/"+f,c(!0)):c(!1)}function l(){c(!1)}function p(){c(!1)}function c(e){t(function(){n.$apply(function(){o.success=e,delete o.progress,delete o.speed,delete o.cancel,delete o.upload,delete o.webkitRelativePath,delete o.lastModifiedDate,delete o.lastModified,n.start_upload_state=!1,e?u.resolve(o):u.reject(g),n.start_upload_state=!1})},0)}var u=e.defer(),d=o.name.split(".").pop().toLowerCase(),f=n.options.folder||"";f+=n.options.filename?n.options.filename+"."+d:o.name.replace(" ","-");var y=new FormData;y.append("key",f),y.append("acl",n.options.acl||"public-read"),y.append("Content-Type",o.type),y.append("AWSAccessKeyId",n.options.policy.key),y.append("policy",n.options.policy.policy),y.append("signature",n.options.policy.signature),y.append("file",o);var g=new XMLHttpRequest;g.upload.addEventListener("progress",a,!1),g.addEventListener("load",r,!1),g.addEventListener("error",l,!1),g.addEventListener("abort",p,!1),g.open("POST","https://"+n.options.bucket+".s3.amazonaws.com/",!0),g.send(y),o.upload=!0,o.progress=!1,o.percent=0,o.cancel=function(){g.abort(),delete o};var h=0,v=(new Date).getTime(),m=0,b=0;return u.promise}return{process:o}}).directive("s3Upload",function(){return{restrict:"EA",scope:{s3Upload:"="},link:function(e,t){t.bind("click",function(){e.$parent.$broadcast("s3uploader:start")}),t.css({visibility:"hidden"}),e.$watch("s3Upload",function(){angular.forEach(e.s3Upload,function(e){return e.real||t.css({visibility:"visible"}),!1})},!0)}}}).filter("filesize",function(){return function(e,t){if(isNaN(parseFloat(e))||!isFinite(e))return"-";"undefined"==typeof t&&(t=1);var o=["bytes","kB","MB","GB","TB","PB"],i=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(i))).toFixed(t)+" "+o[i]}}).filter("speedsize",function(){return function(e,t){if(isNaN(parseFloat(e))||!isFinite(e))return"-";"undefined"==typeof t&&(t=1);var o=["Kb/s","Kbs/s","Mbs/s","Gbs/s","Tbs/s","Pbs/s"],i=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(i))).toFixed(t)+" "+o[i]}})}();